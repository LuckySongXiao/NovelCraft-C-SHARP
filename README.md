# 小说管理系统 - C# 版本

## 项目概述

这是一个功能完整的小说创作和管理系统，采用C# WPF技术栈开发，支持多Agent AI协作创作、完整的内容管理、设定管理等功能。系统设计高度模块化，具有良好的可扩展性和维护性。

## 系统架构

### 技术栈
- **开发语言**: C# (.NET 8.0)
- **UI框架**: WPF (Windows Presentation Foundation)
- **数据库**: SQLite (本地存储) + Entity Framework Core
- **依赖注入**: Microsoft.Extensions.DependencyInjection
- **日志系统**: Serilog
- **配置管理**: Microsoft.Extensions.Configuration
- **AI集成**: 支持多种AI提供商 (OpenAI, DeepSeek, RWKV等)
- **文档处理**: DocumentFormat.OpenXml, iTextSharp
- **数据序列化**: Newtonsoft.Json

### 架构分层

```
┌─────────────────────────────────────────────────────────────┐
│                    表现层 (Presentation Layer)                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   主界面模块     │  │   项目管理界面   │  │   内容管理界面   │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   设定管理界面   │  │   AI助手界面    │  │   统计报告界面   │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│                   应用服务层 (Application Layer)               │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   项目应用服务   │  │   内容应用服务   │  │   AI协作服务    │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   导入导出服务   │  │   统计报告服务   │  │   配置管理服务   │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│                   业务逻辑层 (Domain Layer)                    │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   项目管理服务   │  │   卷宗管理服务   │  │   章节管理服务   │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   人物管理服务   │  │   势力管理服务   │  │   设定管理服务   │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   AI Agent引擎   │  │   工作流引擎    │  │   记忆管理系统   │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│                   基础设施层 (Infrastructure Layer)            │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   数据访问层     │  │   文件系统服务   │  │   AI提供商集成   │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   日志系统       │  │   配置系统      │  │   缓存系统      │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└────────────────────────────────────────────────────────────────┘
```

## 核心功能模块

### 1. 项目管理系统
- **项目创建与配置**: 支持创建新的小说项目，配置基本信息
- **项目概览**: 显示项目统计信息、创作进度、最近活动
- **多项目管理**: 支持同时管理多个小说项目
- **项目模板**: 提供不同类型小说的项目模板

### 2. 卷宗管理系统
- **卷宗结构管理**: 支持多层级的卷宗结构
- **章节管理**: 章节的创建、编辑、排序、统计
- **内容编辑器**: 富文本编辑器，支持格式化、插入图片等
- **版本控制**: 章节内容的版本历史和回滚功能

### 3. 内容管理系统
- **人物管理**: 角色档案、关系网络、发展轨迹
- **势力管理**: 组织架构、势力关系、地盘分布
- **剧情管理**: 主线支线、伏笔设定、时间线管理
- **资源管理**: 各类资源的分布和统计
- **关系网络**: 可视化的关系图谱

### 4. 设定管理系统
- **世界观设定**: 地理、历史、文化、政治体系、自然法则、社会结构
- **修炼体系**: 完整的修炼等级体系、力量来源、境界划分、能力分类、禁忌之术
- **政治体系**: 政府类型、权力结构、法律体系、政治关系
- **货币体系**: 货币制度、基础货币、发行机构、经济指标、金融服务
- **商业体系**: 经济制度、市场结构、贸易体系、商业组织、市场机制
- **种族类别**: 种族分类、生理特征、文化特征、社会结构、种族关系
- **功法体系**: 功法分类、修炼要求、技能招式、传承信息
- **装备体系**: 装备分类、品级系统、属性系统、强化系统、制作信息
- **宠物体系**: 宠物分类、稀有度、技能系统、进化系统、培养系统
- **地图结构**: 多层级地图、地形类型、气候类型、资源分布、特殊区域
- **维度结构**: 维度分类、稳定性、访问等级、环境特征、连接传送
- **灵宝体系**: 灵宝分类、品级等级、灵性等级、炼制信息、器灵系统
- **时间线管理**: 时间线类型、事件管理、关联关系、时间特性
- **生民体系**: 人口统计、社会阶层、教育体系、医疗体系、文化生活
- **司法体系**: 法律体系、法院体系、审判程序、执法机构、刑罚制度
- **职业体系**: 职业分类、技能体系、晋升路径、薪酬体系、工作环境

### 5. AI Agent协作系统
- **多Agent工作流**: 编剧、作家、总结、读者、设定管理Agent协作创作
- **智能对话创作**: 多轮对话引擎、上下文记忆、意图识别、智能问题生成
- **内容生成引擎**: 世界设定生成、人物角色生成、剧情故事生成、章节续写
- **一致性检查**: 人物设定一致性、世界观逻辑性、时间线合理性、剧情连贯性
- **AI协作工作流**: 任务调度管理、AI协作协调、人工干预支持、质量控制机制
- **智能辅助功能**: 模板库管理、批量生成、历史记录、思维链展示、参数调节
- **项目数据集成**: 全项目数据读取、智能数据分析、自动数据更新、跨模块协作
- **超长文本处理**: 分层记忆架构、智能记忆压缩、渐进式处理、上下文传递
- **多AI提供商支持**: OpenAI、Claude、智谱AI、硅基流动、谷歌AI、GROK3、Ollama本地
- **AI功能测试**: 基础API测试、功能模块测试、性能压力测试、质量评估、调试诊断

### 6. 导入导出系统
- **多格式支持**: Excel(.xlsx)、Word(.docx)、TXT、JSON、Markdown、PDF、EPUB
- **智能解析**: 自动识别文档结构、内容类型、章节划分、人物信息提取
- **成建制导出**: 完整项目数据导出、目录结构生成、统计报告、说明文档
- **部分内容导出**: 选择性模块导出、按维度导出、保持关联关系
- **批量操作**: 支持批量导入导出、格式转换、增量导入、冲突解决
- **发布格式**: 起点中文网、晋江文学网、纵横中文网、通用发布格式
- **智能导入**: 小说文本解析、信息提取、数据结构化、交互式完善
- **版本控制**: 导入导出历史、版本回滚、数据备份、完整性检查

### 7. 统计报告系统
- **创作统计**: 字数统计、章节统计、卷宗统计、创作进度、效率分析
- **内容分析**: 人物出场频率、势力影响力、剧情发展分析、关系网络分析
- **设定统计**: 世界观完整性、修炼体系统计、装备分布、资源统计
- **质量评估**: 内容质量评分、一致性检查、逻辑性分析、改进建议
- **数据可视化**: 统计图表、关系图谱、地图分布、发展趋势
- **报告生成**: 项目概览报告、详细统计报告、质量分析报告、导出报告
- **实时监控**: 创作进度监控、数据变化追踪、异常检测、性能监控

## 项目结构

```
NovelManagementSystem/
├── src/
│   ├── NovelManagement.Core/              # 核心领域模型
│   │   ├── Entities/                      # 实体类
│   │   ├── ValueObjects/                  # 值对象
│   │   ├── Enums/                        # 枚举类型
│   │   ├── Interfaces/                   # 核心接口
│   │   └── Exceptions/                   # 自定义异常
│   │
│   ├── NovelManagement.Infrastructure/    # 基础设施层
│   │   ├── Data/                         # 数据访问
│   │   ├── AI/                          # AI提供商集成
│   │   ├── FileSystem/                  # 文件系统服务
│   │   ├── Logging/                     # 日志系统
│   │   ├── Configuration/               # 配置管理
│   │   └── Cache/                       # 缓存系统
│   │
│   ├── NovelManagement.Application/       # 应用服务层
│   │   ├── Services/                     # 应用服务
│   │   ├── DTOs/                        # 数据传输对象
│   │   ├── Mappers/                     # 对象映射
│   │   ├── Validators/                  # 数据验证
│   │   └── Interfaces/                  # 应用接口
│   │
│   ├── NovelManagement.Domain/            # 业务逻辑层
│   │   ├── Services/                     # 领域服务
│   │   ├── Repositories/                # 仓储接口
│   │   ├── Specifications/              # 规约模式
│   │   ├── Events/                      # 领域事件
│   │   └── Factories/                   # 工厂模式
│   │
│   ├── NovelManagement.AI/               # AI集成层
│   │   ├── Agents/                      # AI Agent实现
│   │   ├── Workflows/                   # 工作流引擎
│   │   ├── Memory/                      # 记忆管理
│   │   ├── Providers/                   # AI提供商
│   │   └── Models/                      # AI模型定义
│   │
│   └── NovelManagement.WPF/              # WPF表现层
│       ├── Views/                       # 视图
│       ├── ViewModels/                  # 视图模型
│       ├── Controls/                    # 自定义控件
│       ├── Converters/                  # 值转换器
│       ├── Behaviors/                   # 行为
│       ├── Styles/                      # 样式资源
│       └── Resources/                   # 资源文件
│
├── tests/                               # 测试项目
│   ├── NovelManagement.Core.Tests/
│   ├── NovelManagement.Application.Tests/
│   ├── NovelManagement.Domain.Tests/
│   ├── NovelManagement.AI.Tests/
│   └── NovelManagement.Integration.Tests/
│
├── tools/                               # 工具和脚本
│   ├── DatabaseMigration/               # 数据库迁移工具
│   ├── DataImport/                      # 数据导入工具
│   └── TestDataGenerator/               # 测试数据生成器
│
├── docs/                                # 文档
│   ├── Architecture.md                  # 架构文档
│   ├── API.md                          # API文档
│   ├── UserGuide.md                    # 用户指南
│   └── DeveloperGuide.md               # 开发者指南
│
├── scripts/                             # 构建和部署脚本
│   ├── build.bat                       # 构建脚本
│   ├── test.bat                        # 测试脚本
│   └── deploy.bat                      # 部署脚本
│
└── NovelManagementSystem.sln           # 解决方案文件
```

## 开发环境要求

### 系统要求
- **操作系统**: Windows 10 或更高版本
- **开发环境**: Visual Studio 2022 或 Visual Studio Code
- **.NET版本**: .NET 8.0 或更高版本
- **数据库**: SQLite (无需额外安装)

### 开发工具
- **IDE**: Visual Studio 2022 Community/Professional
- **版本控制**: Git
- **包管理**: NuGet
- **文档工具**: Markdown编辑器
- **数据库工具**: DB Browser for SQLite

## 安装和运行

### 1. 克隆项目
```bash
git clone [项目地址]
cd 小说管理系统_C#
```

### 2. 还原依赖包
```bash
dotnet restore
```

### 3. 构建项目
```bash
dotnet build
```

### 4. 运行应用
```bash
dotnet run --project src/NovelManagement.WPF
```

### 5. 运行测试
```bash
dotnet test
```

## 核心特性

### 高度模块化设计
- 采用分层架构，各层职责清晰
- 使用依赖注入，降低耦合度
- 支持插件式扩展，便于功能增强

### 智能AI协作
- 多Agent协作工作流
- 智能内容生成和优化
- 上下文感知的创作辅助
- 质量评估和改进建议

### 完整的内容管理
- 结构化的内容组织
- 丰富的关系管理
- 可视化的数据展示
- 灵活的查询和筛选

### 强大的导入导出
- 多种文件格式支持
- 智能内容解析
- 批量操作功能
- 发布格式适配

### 数据安全保障
- 本地数据存储
- 自动备份机制
- 版本控制功能
- 数据完整性检查

## 扩展性设计

### 插件系统
系统支持插件式扩展，可以轻松添加新功能：
- AI提供商插件
- 导入导出格式插件
- 自定义报表插件
- 第三方集成插件

### 配置系统
灵活的配置管理，支持：
- 用户个性化设置
- AI模型配置
- 界面主题配置
- 功能开关配置

### 国际化支持
预留国际化接口，支持：
- 多语言界面
- 本地化资源
- 区域化设置
- 文化适配

## 安全性考虑

### 数据安全
- 本地数据存储，避免隐私泄露
- 数据加密存储选项
- 访问权限控制
- 操作日志记录

### AI安全
- API密钥安全管理
- 请求频率限制
- 内容过滤机制
- 错误处理和恢复

## 性能优化

### 内存管理
- 大文本分段处理
- 智能缓存策略
- 内存使用监控
- 垃圾回收优化

### 响应性能
- 异步操作处理
- 后台任务调度
- 进度反馈机制
- 用户体验优化

## AI Agent协作工作流程详解

### 核心Agent角色定义

#### 1. 编剧Agent (Director AI)
- **职责**: 总体剧情架构师，负责大纲、设定、主线规划
- **推荐模型**: DeepSeek-R1 (推理能力强，适合逻辑构建)
- **核心功能**: 大纲生成、设定构建、主线规划、章节安排、剧情调整

#### 2. 作家Agent (Writer AI)
- **职责**: 章节内容创作者，负责具体文本生成
- **推荐模型**: RWKV-7-G1 (文本生成能力强，创意丰富)
- **核心功能**: 章节内容生成、对话描写、场景描述、心理刻画、文风保持

#### 3. 总结Agent (Summarizer AI)
- **职责**: 内容整理和承上启下，负责总结和前言
- **推荐模型**: GLM-4-LONG (长文本处理能力强)
- **核心功能**: 章节总结、卷宗总结、前言生成、关键信息提取、连贯性维护

#### 4. 读者Agent (Reader AI)
- **职责**: 模拟读者视角，提供评价和建议
- **推荐模型**: QWEN-3 (理解能力强，评价客观)
- **核心功能**: 内容评价、问题识别、反馈建议、质量评估、吸引力分析

#### 5. 设定管理Agent (Setting Manager AI)
- **职责**: 维护设定一致性，管理世界观数据
- **推荐模型**: Claude-3-Sonnet (逻辑严密，细节处理好)
- **核心功能**: 一致性维护、冲突检查、设定更新、查询服务、关联分析

### 多Agent协作工作流程

#### 阶段1: 项目初始化和大纲创建
```
用户输入命题 → 编剧Agent分析 → 生成初步大纲 → 设定管理Agent建立基础设定库 → 读者Agent初步评估 → 编剧Agent优化大纲
```

#### 阶段2: 章节创作循环
```
编剧Agent提供章节要求 → 作家Agent生成章节内容 → 设定管理Agent一致性检查 → 读者Agent评价反馈 → 总结Agent章节总结 → 进入下一章节
```

#### 阶段3: 卷宗完成和总结
```
总结Agent卷宗总结 → 编剧Agent下卷规划 → 总结Agent生成前言 → 读者Agent整体评估 → 编剧Agent调整后续规划
```

### 超长文本分段记忆处理机制

#### 分层记忆架构
- **全局记忆层**: 核心世界观设定、主要人物信息、整体剧情大纲
- **卷宗记忆层**: 当前卷剧情线、人物发展轨迹、重要事件
- **章节记忆层**: 当前章节内容、人物状态、场景对话
- **段落记忆层**: 当前处理文本、局部上下文、临时状态

#### 智能记忆压缩策略
- **重要性评分**: 对信息进行1-10分重要性评分
- **动态管理**: 自动压缩低重要性信息，保留核心内容
- **检索优化**: 基于任务需求智能检索相关记忆

### 导入导出功能详解

#### 支持的文件格式
- **Excel文件 (.xlsx)**: 结构化数据导入导出，支持多工作表
- **Word文档 (.docx)**: 富文本内容导入导出，保持格式
- **纯文本 (.txt)**: 简单文本导入导出，兼容性最好
- **JSON格式 (.json)**: 完整项目数据导入导出，保持结构
- **Markdown (.md)**: 文档化导出，便于阅读和分享

#### 导出文件夹结构
```
{项目名称}_{导出时间}_{导出类型}/
├── 项目概览/
├── 卷宗管理/
├── 内容管理/
├── 设定管理/
├── 统计报告/
└── 说明文档/
```

---

## 📊 项目完成状态 (2024年12月10日更新)

### 🎯 总体进度: 100% ✅

| 模块 | 状态 | 完成度 | 说明 |
|------|------|--------|------|
| 架构层次 | ✅ | 100% (6/6) | 所有架构层完成 |
| WPF界面 | ✅ | 100% (21/21) | 所有界面完成 |
| 应用服务 | ✅ | 100% (20/20) | 所有服务完成 |
| AI Agent系统 | ✅ | 100% (7/7) | AI系统完整 |
| 导入导出 | ✅ | 100% (7/7) | 多格式支持 |
| 测试项目 | ✅ | 100% (6/6) | 测试覆盖完整 |

### 🔧 最新修复 (2024年12月10日)
- ✅ **章节保存功能完全修复**: 解决所有数据库约束问题
- ✅ **外键约束处理**: 完善项目-卷-章节层次结构
- ✅ **UNIQUE约束优化**: 智能处理项目名称冲突
- ✅ **错误处理增强**: 详细错误信息和调试输出
- ✅ **自动保存机制**: 章节编辑器支持自动保存

### 📈 项目统计
- **总代码文件数**: 200+ 个文件
- **总代码行数**: 25,000+ 行
- **编译状态**: ✅ 成功 (0错误, 1468警告)
- **启动状态**: ✅ 正常启动
- **数据库状态**: ✅ 正常连接和操作

### 🚀 快速启动
```bash
# 1. 克隆项目
git clone [项目地址]
cd 小说管理系统

# 2. 恢复依赖
dotnet restore

# 3. 编译项目
dotnet build

# 4. 运行应用
src\NovelManagement.WPF\bin\Debug\net8.0-windows\NovelManagement.WPF.exe
```

### 📋 详细进度
查看 [完成进度.md](完成进度.md) 了解详细的完成状态和功能清单。

---

**项目状态**: 🎉 **100% 完成，可投入生产使用！**

*本文档会随着项目开发进度持续更新*
