# 角色管理功能修复说明

## 问题描述

在角色管理中编辑角色信息之后，系统没有在全局变更角色信息，另外无法使用删除按键删除角色信息。需要实现以下功能：

1. 对于已创建未被引用的角色可以被删除
2. 对于已创建已被引用的角色只允许被编辑修改角色信息
3. 角色信息被修改之后需要在全局同步变动

## 解决方案

### 1. 新增角色引用检查功能

#### 1.1 创建数据传输对象
- `CharacterReferenceInfo.cs`: 角色引用信息类
- `CharacterDeleteResult.cs`: 角色删除结果类

#### 1.2 扩展CharacterService
在 `CharacterService` 中新增以下方法：

- `CheckCharacterReferencesAsync()`: 检查角色是否被其他实体引用
  - 检查角色关系
  - 检查章节中的首次/最后出场
  - 检查剧情中的引用

- `SafeDeleteCharacterAsync()`: 安全删除角色
  - 先检查引用
  - 如果被引用则拒绝删除
  - 如果未被引用则执行删除

### 2. 修改角色管理界面

#### 2.1 数据模型更新
- 将 `CharacterViewModel` 替换为 `Character` 实体
- 使用真实的数据库服务而不是模拟数据

#### 2.2 服务集成
- 通过依赖注入获取 `CharacterService`
- 集成真实的数据库操作

#### 2.3 功能增强

**编辑功能**：
- 调用 `CharacterService.UpdateCharacterAsync()` 进行数据库同步
- 更新本地集合以保持界面一致性
- 提供服务不可用时的降级处理

**删除功能**：
- 调用 `CharacterService.CheckCharacterReferencesAsync()` 检查引用
- 如果被引用，显示引用详情并提供编辑选项
- 如果未被引用，调用 `SafeDeleteCharacterAsync()` 安全删除
- 提供详细的用户反馈

**新建功能**：
- 调用 `CharacterService.CreateCharacterAsync()` 创建角色
- 自动设置项目ID和其他必要字段

### 3. 对话框更新

#### 3.1 CharacterEditDialog
- 更新为使用 `Character` 实体而不是 `CharacterViewModel`
- 正确处理势力信息（Faction对象）
- 保持向后兼容性

#### 3.2 CharacterDeleteDialog
- 更新为使用 `Character` 实体
- 正确显示势力名称

### 4. 错误处理和日志

- 添加详细的错误处理
- 提供用户友好的错误消息
- 记录操作日志用于调试

## 技术实现细节

### 引用检查逻辑

```csharp
public async Task<CharacterReferenceInfo> CheckCharacterReferencesAsync(Guid characterId)
{
    var referenceInfo = new CharacterReferenceInfo();
    
    // 检查角色关系
    var relationships = await _unitOfWork.CharacterRelationships.GetByCharacterIdAsync(characterId);
    if (relationships.Any())
    {
        referenceInfo.IsReferenced = true;
        referenceInfo.References.Add($"存在 {relationships.Count()} 个角色关系");
    }
    
    // 检查章节引用
    var chaptersAsFirst = await _unitOfWork.Chapters.FindAsync(c => c.FirstAppearanceCharacterId == characterId);
    // ... 其他检查
    
    return referenceInfo;
}
```

### 安全删除逻辑

```csharp
public async Task<CharacterDeleteResult> SafeDeleteCharacterAsync(Guid id)
{
    // 检查角色是否存在
    var character = await _unitOfWork.Characters.GetByIdAsync(id);
    if (character == null)
        return new CharacterDeleteResult { Success = false, Message = "角色不存在" };
    
    // 检查引用
    var referenceInfo = await CheckCharacterReferencesAsync(id);
    if (referenceInfo.IsReferenced)
        return new CharacterDeleteResult { Success = false, Message = "角色已被引用，无法删除", ReferenceInfo = referenceInfo };
    
    // 执行删除
    await _unitOfWork.Characters.DeleteAsync(character);
    await _unitOfWork.SaveChangesAsync();
    
    return new CharacterDeleteResult { Success = true, Message = "角色删除成功" };
}
```

## 用户体验改进

1. **智能删除提示**：当用户尝试删除被引用的角色时，系统会显示具体的引用信息，并提供编辑选项
2. **数据同步**：角色编辑后立即同步到数据库，确保数据一致性
3. **错误恢复**：当服务不可用时，提供本地操作模式，避免功能完全不可用
4. **操作反馈**：提供详细的操作结果反馈，让用户了解操作状态

## 测试验证

创建了 `CharacterManagementTestHelper` 类用于验证功能：
- 测试角色引用检查
- 测试安全删除功能
- 验证角色数据完整性

## 注意事项

1. 当前项目ID使用临时生成的GUID，实际使用时应从项目上下文获取
2. AI相关功能已更新以使用新的数据模型
3. 保持了向后兼容性，现有功能不受影响
4. 所有数据库操作都是异步的，提高了性能

## 后续优化建议

1. 实现项目上下文管理，正确获取当前项目ID
2. 添加批量操作功能
3. 实现角色导入/导出功能的真实逻辑
4. 添加更多的引用检查类型（如世界设定、资源等）
5. 实现角色变更历史记录
